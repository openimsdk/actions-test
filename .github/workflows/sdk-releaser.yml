name: SDK Releaser

on:
  release:
    types: [created]
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v2

      - name: Install NDK
        run: |
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;20.0.5594570"

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init

      - name: Build Android AAR
        run: |
          gomobile bind -v -trimpath -ldflags="-s -w" \
            -o ./open_im_sdk.aar -target=android \
            ./open_im_sdk/ ./open_im_sdk_callback/

      - name: Upload Android AAR to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: open_im_sdk.aar
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init

      - name: Build iOS xcframework
        run: |
          gomobile bind -v -trimpath -ldflags="-s -w" \
            -o ./OpenIMSDK.xcframework -target=ios \
            ./open_im_sdk/ ./open_im_sdk_callback/

      - name: Create iOS archive
        run: |
          zip -r OpenIMSDK.xcframework.zip OpenIMSDK.xcframework

      - name: Upload iOS xcframework to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: OpenIMSDK.xcframework.zip
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-wasm:
    runs-on: ubuntu-latest
    env:
      TAG_VERSION: ${{ github.ref_name }}
      PROJECT_NAME: ${{ github.event.repository.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install make and zip
        run: sudo apt-get update && sudo apt-get install -y make zip

      - name: Build WASM
        run: |
          cd wasm/cmd
          make wasm

      - name: Create WASM archive
        run: |
          cd wasm/cmd
          archive_name="${PROJECT_NAME}_${TAG_VERSION}_JS_wasm.zip"
          zip $archive_name openIM.wasm
          echo "Created archive: $archive_name"

      - name: List generated files
        run: |
          cd wasm/cmd
          archive_name="${PROJECT_NAME}_${TAG_VERSION}_JS_wasm.zip"
          echo "Generated WASM files:"
          ls -la openIM.wasm
          ls -la $archive_name
          echo "Archive contents:"
          unzip -l $archive_name

      - name: Upload WASM files to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: wasm/cmd/${{ env.PROJECT_NAME }}_${{ env.TAG_VERSION }}_JS_wasm.zip
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
