name: Create Pre-Release PR from Milestone

on:
  workflow_dispatch:  # Allows manual trigger
    inputs:
      milestone_name:
        description: 'Milestone name to collect closed PRs from'
        required: true
        default: 'v3.8.2'  # Default milestone name
      target_branch:
        description: 'Target branch to merge the consolidated PR'
        required: true
        default: 'pre-release-v3.8.2'  # Default target branch
  schedule:
    - cron: '0 10 * * 0'  # Scheduled to run every Sunday at 10:00 UTC

env:
  MILESTONE_NAME: ${{ github.event.inputs.milestone_name || 'v3.8.2' }}
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'pre-release-v3.8.2' }}

jobs:
  cherry_pick_milestone_prs:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Git user details for commits
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Step 3: Fetch milestone ID based on milestone name
      - name: Fetch Milestone ID
        id: get_milestone_id
        run: |
          # Fetch all milestones and find the ID for the specified milestone name
          milestones=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/milestones")

          # Extract the milestone ID based on milestone title
          milestone_id=$(echo "$milestones" | grep -B3 "\"title\": \"$MILESTONE_NAME\"" | grep '"number":' | head -n1 | grep -o '[0-9]\+')
          if [ -z "$milestone_id" ]; then
            echo "Milestone '$MILESTONE_NAME' not found. Exiting."
            exit 1
          fi

          echo "Milestone ID: $milestone_id"
          echo "MILESTONE_ID=$milestone_id" >> $GITHUB_ENV

      # Step 4: Fetch closed issues with specified milestone ID and filter for PRs
      - name: Fetch Closed PRs from Milestone ID and Extract Merge Commits
        run: |
          # Fetch all closed issues (including PRs) with the specified milestone ID
          issues=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues?milestone=${{ env.MILESTONE_ID }}&state=closed&per_page=100")

          # Initialize files to store PR numbers and commit hashes
          > pr_numbers.txt
          > commit_hashes.txt

          # Loop over each issue and filter only PRs
          echo "$issues" | grep -E '"number":|"pull_request":' | while read -r line; do
            if [[ $line == *'"number":'* ]]; then
              pr_number=$(echo "$line" | grep -o '[0-9]\+')
            elif [[ $line == *'"pull_request":'* ]]; then
              # Confirm it's a PR by presence of "pull_request" field, add to pr_numbers.txt
              echo "#$pr_number" >> pr_numbers.txt
              # Get the merge_commit_sha using another API call for each PR
              merge_commit=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number" | grep '"merge_commit_sha":' | grep -o '"[a-f0-9]\{40\}"' | tr -d '"')
              if [[ -n "$merge_commit" ]]; then
                echo "$merge_commit" >> commit_hashes.txt
              fi
            fi
          done

          # Display parsed PR numbers and merge commits
          echo "Parsed PR numbers:"
          cat pr_numbers.txt || echo "No PR numbers found for milestone."
          echo "Parsed merge commits:"
          cat commit_hashes.txt || echo "No merge commits found for milestone."

      # Step 5: Cherry-pick all selected merge commits into a new branch
      - name: Cherry-pick Merged Commits and Create Branch
        run: |
          # Check if commit_hashes.txt has valid entries
          if [ ! -s commit_hashes.txt ]; then
            echo "No valid PRs found with merge commits. Exiting."
            exit 1
          fi

          # Generate a branch name using the first commit hash
          first_commit_hash=$(head -n 1 commit_hashes.txt)
          cherry_pick_branch="cherry-pick-${first_commit_hash:0:7}"

          # Checkout main and create a new branch for cherry-pick
          git checkout main
          git pull origin main
          git checkout -b $cherry_pick_branch

          # Perform cherry-pick for each commit individually
          while IFS= read -r commit_hash; do
            echo "Attempting to cherry-pick commit $commit_hash"
            if ! git cherry-pick "$commit_hash"; then
              echo "Cherry-pick failed for commit $commit_hash, skipping..."
              git cherry-pick --abort
            fi
          done < commit_hashes.txt

          # Push the new cherry-pick branch to the repository
          git push origin $cherry_pick_branch

      # Step 6: Create a pull request to merge the cherry-pick branch into the target branch
      - name: Create Pull Request to Target Branch
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: $cherry_pick_branch
          base: ${{ env.TARGET_BRANCH }}
          title: "Consolidated PRs for Pre-Release - ${{ env.TARGET_BRANCH }}"
          body: |
            This PR includes cherry-picked changes from closed PRs in milestone '${{ env.MILESTONE_NAME }}'.
            Included PRs:
            $(cat pr_numbers.txt | awk '{print "- " $1}')
