name: Create Pre-Release PR from Milestone

on:
  workflow_dispatch:  # Allows manual trigger
    inputs:
      milestone:
        description: 'Milestone name to collect closed PRs from'
        required: true
        default: 'v3.8.2'  # Default milestone name
      target_branch:
        description: 'Target branch to merge the consolidated PR'
        required: true
        default: 'pre-release-v3.8.2'  # Default target branch

jobs:
  cherry_pick_milestone_prs:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Git user details for commits
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # Step 3: Fetch closed PRs for the specified milestone using GitHub API
      - name: Fetch Closed PRs from Milestone
        id: fetch_prs
        env:
          MILESTONE: ${{ github.event.inputs.milestone }}
        run: |
          # Fetch all closed PRs for the specified milestone using the GitHub API
          prs=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&milestone=$MILESTONE")

          # Initialize pr_commits.txt to store PR numbers and commit hashes
          > pr_commits.txt
          echo "$prs" | grep '"number":' | awk '{print $2}' | tr -d ',' | while read pr_number; do
            # Find the merge commit for each PR
            merge_commit=$(git log --grep="Merge pull request #$pr_number" --pretty=format:"%H" -n 1)
            if [ -n "$merge_commit" ]; then
              echo "$pr_number:$merge_commit" >> pr_commits.txt
            fi
          done

          # Display parsed PR numbers and merge commits
          echo "Parsed PR numbers and merge commits:"
          cat pr_commits.txt || echo "No PRs found for milestone."

      # Step 4: Cherry-pick all selected merge commits into a new branch
      - name: Cherry-pick Merged Commits and Create Branch
        env:
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
        run: |
          # Check if pr_commits.txt has valid entries
          if [ ! -s pr_commits.txt ]; then
            echo "No valid PRs found with merge commits. Exiting."
            exit 1
          fi

          # Read merge commit hashes from pr_commits.txt
          commit_hashes=$(awk -F':' '{print $2}' pr_commits.txt | tr '\n' ' ')

          # Generate a branch name using the first commit hash
          first_commit_hash=$(awk -F':' 'NR==1 {print $2}' pr_commits.txt)
          cherry_pick_branch="cherry-pick-${first_commit_hash:0:7}"

          # Checkout main and create a new branch for cherry-pick
          git checkout main
          git pull origin main
          git checkout -b $cherry_pick_branch

          # Perform cherry-pick for all commits in one command
          git cherry-pick $commit_hashes || git cherry-pick --abort

          # Push the new cherry-pick branch to the repository
          git push origin $cherry_pick_branch

      # Step 5: Create a pull request to merge the cherry-pick branch into the target branch
      - name: Create Pull Request to Target Branch
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: $cherry_pick_branch
          base: ${{ github.event.inputs.target_branch }}
          title: "Consolidated PRs for Pre-Release - ${{ github.event.inputs.target_branch }}"
          body: |
            This PR includes cherry-picked changes from closed PRs in milestone '${{ github.event.inputs.milestone }}'.
            PRs and corresponding merge commits:
            $(cat pr_commits.txt | awk '{print "- PR #" $1 " - Commit " $2}')
